<link rel="import" href="promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="./styles.html">
<link rel="import" href="polymer/polymer.html">
<link rel="import" href="marked-element/marked-element.html">
<link rel="import" href="iron-ajax/iron-ajax.html">
<link rel="import" href="warp10-warpscript-widget.html">
<link rel="import" href="menu.html">
<script src="../js/prism.js"></script>
<dom-module id="warp10-layout">

  <template>
    <style include="style-module">
      .nav .collapse, .nav .nav-link .nav {
        margin-left: 10px;
      }

      .nav .nav-link {
        max-width: 200px;
      }

      .nav .nav-link.active {
        font-weight: bold;
      }

      .nav .nav-link.active:before {
        content: '> ';
      }

      .main-container {
        margin-top: 100px;
      }

    </style>
    <app-route
      route="{{route}}"
      pattern="/:md"
      data="{{routeData}}"></app-route>


    <template is="dom-if" if="{{route.path}}" restamp>
      <div class="container main-container" id="main-container">
        <iron-ajax
          auto
          url="[[getFile(route.path)]]"
          handle-as="json"
          on-response="_handleResponse"
          last-response="{{ajaxResponse}}"
          debounce-duration="300"></iron-ajax>
        <div class="row">
          <dom-if if="[[withMenu]]">
            <template>
              <div class="col-sm-3">
                <warp10-menu></warp10-menu>
              </div>
            </template>
          </dom-if>
          <div id="panel">
            <div class="container">
              <h1>[[title]]</h1>
              <blockquote class="blockquote">[[desc]]</blockquote>
              <div id="content"></div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </template>
  <script>
    class Warp10Layout extends Polymer.Element {
      static get is() {
        return 'warp10-layout'
      }

      static get properties() {
        return {
          withMenu: {
            type: Boolean,
            value: false,
          }
        }
      }

      _handleResponse(event, ironRequest) {
        event.stopPropagation();
        this.root.querySelector('#content').innerHTML = ironRequest.response.content
          .replace(new RegExp('\{%[ ]+raw[ ]+%\}', 'g'), '')
          .replace(new RegExp('\{%[ ]+endraw[ ]+%\}', 'g'), '');
        this.title = ironRequest.response.title;
        this.desc = ironRequest.response.desc;
        this.root.querySelectorAll('code').forEach(function (element) {
          Prism.highlightElement(element, false);
        });
        this.root.querySelector('#content').querySelectorAll('a').forEach(function (element) {
          console.log('[warp10-layout] _handleResponse', element.getAttribute('href'));
          if (!!element.getAttribute('href')) {
            if (element.getAttribute('href').indexOf('http') === -1) {
              let pathUrl = element.getAttribute('href');
              if (pathUrl.indexOf('/') !== 0) {
                let spath = this.route.path.split('/');
                let newPath = '';
                spath.slice(1).forEach(function (p) {
                  newPath += '/' + p;
                });
                pathUrl = newPath + '/' + pathUrl
              }
              let path = ('#/doc/' + pathUrl).replace(new RegExp('//', 'g'), '/');
              element.setAttribute('href', path);
            } else {
              element.setAttribute('target', '_blank');
            }
          }
        }.bind(this));
        this.root.querySelector('#panel').classList.add(this.withMenu ? 'col-sm-9' : 'col-sm-12');
      }

      getFile(path) {
        let spath = path.split('/');
        let md = 'raw';
        spath.slice(1).forEach(function (p) {
          md += '/' + p;
        });
        console.log('[warp10-layout] - getFile', md + '/raw.json');
        return md + '/raw.json'
      }

      _stringify(obj) {
        return JSON.stringify(obj);
      }
    }

    customElements.define(Warp10Layout.is, Warp10Layout);
  </script>
</dom-module>