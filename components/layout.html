<link rel="import" href="promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="./styles.html">
<link rel="import" href="polymer/polymer.html">
<link rel="import" href="marked-element/marked-element.html">
<link rel="import" href="app-route/app-route.html">
<link rel="import" href="iron-ajax/iron-ajax.html">
<link rel="import" href="app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="app-layout/app-drawer/app-drawer.html">
<link rel="import" href="app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="warp10-warpscript-widget.html">
<link rel="import" href="menu.html">
<script src="../js/prism.js"></script>
<dom-module id="warp10-layout">

  <template>
    <style include="style-module">
      :host {
        --app-drawer-width: 400px;
      }

      .main-container {
        margin-top: 100px;
        min-height: calc(100vh - 207px);
      }

      app-drawer {
        top: 0;
      }

      app-drawer-layout {
        position: relative;
      }

      @media (max-width: 768px) {
        .main-container {
          min-height: calc(100vh - 223px);
        }
      }

    </style>
    <app-route
      route="{{route}}"
      pattern="/:md"
      data="{{routeData}}"></app-route>


    <template is="dom-if" if="{{route.path}}" restamp>
      <div class="container-fluid main-container" id="main-container">
        <iron-ajax
          auto
          url="[[getFile(route.path)]]"
          handle-as="json"
          on-response="_handleResponse"
          last-response="{{ajaxResponse}}"
          debounce-duration="300"></iron-ajax>
        <app-drawer-layout fullbleed narrow="{{narrow}}">
          <!-- Drawer content -->
          <app-drawer id="menu" slot="drawer" swipe-open="[[narrow]]">
            <dom-if if="[[withMenu]]">
              <template>
                <app-toolbar>
                  <warp10-menu current-path="[[route.path]]"></warp10-menu>
                  <button class="btn btn-outline-dark d-lg-none float-right" type="button" on-click="_toggleMenu">
                    <span class="navbar-toggler-icon fa fa-fw fa-bars"></span>
                  </button>
                </app-toolbar>
              </template>
            </dom-if>
          </app-drawer>
          <div class="container">
            <button class="btn btn-outline-dark d-lg-none" type="button" on-click="_toggleMenu">
              <span class="navbar-toggler-icon fa fa-fw fa-bars"></span>
            </button>
            <h1>[[title]]</h1>
            <blockquote class="blockquote">[[desc]]</blockquote>
            <div id="content"></div>
          </div>
        </app-drawer-layout>
      </div>
    </template>
  </template>
  <script>
    class Warp10Layout extends Polymer.Element {
      static get is() {
        return 'warp10-layout'
      }

      static get properties() {
        return {
          withMenu: {
            type: Boolean,
            value: false,
          },
          name: {
            type: String,
            value: ''
          }
        }
      }

      ready() {
        super.ready();
        if (!this.withMenu) {
          this.updateStyles({
            '--app-drawer-width': 0,
          });
        }
      }

      _toggleMenu() {
        this.root.querySelector('#menu').open();
      }

      _handleResponse(event, ironRequest) {
        event.stopPropagation();
        event.preventDefault();
        if (!this.root.querySelector('#content')) {
          return;
        }
        console.log('[warp10-layout] injecting html');
        this.root.querySelector('#content').innerHTML = ironRequest.response.content
          .replace(new RegExp('\{%[ ]+raw[ ]+%\}', 'g'), '')
          .replace(new RegExp('\{%[ ]+endraw[ ]+%\}', 'g'), '');
        this.title = ironRequest.response.title;
        this.desc = ironRequest.response.desc;
        window.requestAnimationFrame(function () {
          this.root.querySelectorAll('code').forEach(element => Prism.highlightElement(element, false));
          let innerLinks = this._turnObjToArray(this.root.querySelector('#content').querySelectorAll('a'));
          if(innerLinks) {
            innerLinks.map(function (element) {
              if (!!element.getAttribute('href')) {
                if (element.getAttribute('href').indexOf('http') === -1 && element.getAttribute('href').indexOf('mailto') === -1 && element.getAttribute('href').indexOf('assets') === -1) {
                  let pathUrl = element.getAttribute('href');
                  if (pathUrl.indexOf('/') !== 0) {
                    let newPath = this.route.path.split('/').slice(1).reduce((acc, p) => (acc += '/' + p), '');
                    pathUrl = newPath + '/' + pathUrl
                  }
                  let path = ('#/doc/' + pathUrl).replace(new RegExp('//', 'g'), '/');
                  element.setAttribute('href', path);
                } else {
                  element.setAttribute('target', '_blank');
                }
              }
            }.bind(this));
          }
        }.bind(this));
      }

      _turnObjToArray(obj) {
        return [].map.call(obj, function(element) {
          return element;
        })
      };

      getFile(path) {
        if (this.route.prefix !== '/' + this.name) {
          return;
        }
        let md = path.split('/').slice(1).reduce((acc, p) => (acc += '/' + p), 'raw');
        console.log('[warp10-layout] - getFile', md + '/raw.json', this.route.prefix, this.name);
        return md + '/raw.json'
      }
    }

    customElements.define(Warp10Layout.is, Warp10Layout);
  </script>
</dom-module>