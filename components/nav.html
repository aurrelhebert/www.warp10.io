<link rel="import" href="./styles.html">
<link rel="import" href="polymer/polymer.html">
<link rel="import" href="iron-collapse/iron-collapse.html">
<link rel="import" href="fabric-algolia/fabric-algolia.html">

<dom-module id="warp10-nav">

  <template>
    <style include="style-module">


      /* TOP HEADER
      -------------------------------------------------- */
      .navbar {
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .navbar.top-bar {
        border-radius: 0;
        padding: 16px 0;
        z-index: 16;
        box-shadow: none;
      }

      .navbar-toggler {
        border: 1px solid #000;
        color: #000;
        position: absolute;
        right: 21px;
        top: 21px;
      }

      .sps {
        padding: 1em .5em !important;
        position: fixed !important;;
        top: 0;
        left: 0;
        transition: all 0.25s ease;
        width: 100%;
      }

      .sps--abv {
        background-color: transparent;
        color: #000;
      }

      .sps--blw {
        background-color: #fff;
        color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2) !important;
      }

      a.navbar-brand {
        color: #000;
        font-size: 26px;
        font-weight: 800;
        padding: 5px 0 0 10px;
        text-transform: uppercase;
      }

      #sps button.navbar-toggler {
        color: #000;
      }

      a.navbar-brand span {
        color: #039be5;
      }

      .top-bar a.navbar-brand {
        color: #fff;
        font-size: 26px;
        font-weight: 800;
        padding: 5px 0 0 10px;
        text-transform: uppercase;
      }

      .sps--blw.top-bar button.navbar-toggler, .sps--blw.top-bar a.navbar-brand {
        color: #000;
      }

      .top-bar a.navbar-brand span {
        color: #039be5;
      }

      .top-bar .nav-link {
        color: #fff;
        font-size: 1.4rem;
        font-weight: 500;
        padding: 12px 18px !important;
      }

      .sps--blw.top-bar .nav-link {
        color: #000
      }

      .top-bar .navbar-nav .nav-item {
        margin: 0
      }

      .top-bar .nav-link:hover, .top-bar .nav-item.active a {
        color: #fff;
        border-bottom: 2px solid #fff;
        border-radius: 0;
      }

      .sps--blw.top-bar .nav-link:hover, .sps--blw.top-bar .nav-item.active a {
        color: #039be5;
        border-bottom: none;
        border-radius: 0;
      }

      .sps--blw #search_box {
        position: relative;
      }

      .input-group {
        background-color: #fff;
      }

      .input-group input {
        background-color: transparent;
      }

      .input-group span {
        float: right;
        position: absolute;
        right: 0;
        height: 3em;
        width: 3em;
        border: none;
        padding: 0.8em;
        background-color: transparent;
      }

      .aa-dropdown-menu {
        background-color: #FFF;
        border: 1px solid #444;
        border-radius: 4px;
        font-size: 14px;
        padding: 4px;
        text-align: left;
        max-width: 500px !important;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .algolia-docsearch-suggestion--highlight {
        background-color: #039be5;
        color: #fff;
      }

      /* Main category headers */
      .algolia-docsearch-suggestion--category-header {
        background-color: #039be5;
        color: #fff;
      }

      .algolia-docsearch-suggestion--subcategory-column, .algolia-docsearch-suggestion--subcategory-inline, .algolia-docsearch-suggestion--title {
        cursor: pointer;
      }

      .showMe {
        display: block;
      }
    </style>
    <nav class="navbar navbar-expand-lg mb-4 top-bar navbar-static-top sps sps--abv" id="sps">
      <div class="container">
        <button class="navbar-toggler navbar-toggler-left align-top" type="button" on-click="_toggleMenu">
          <span class="fa fa-fw fa-bars"></span>
        </button>
        <a class="navbar-brand mx-auto" href="#">Warp<span><sup>10</sup></span></a>
        <div class="collapse navbar-collapse" id="navbarCollapse1">
          <ul class="navbar-nav ml-auto" id="menu">
            <li class="nav-item"><a class="nav-link" href="/#/">Home
            </a></li>
            <li class="nav-item"><a class="nav-link" href="/#/nav/getting-started/">Quick
              start</a></li>
            <li class="nav-item"><a class="nav-link" href="/#/doc/reference/">Reference</a></li>
            <li class="nav-item"><a class="nav-link" href="/#/nav/community/">Community</a></li>
            <li class="nav-item"><a class="nav-link" href="/#/nav/contact">Contact</a></li>
            <li class="nav-item"><a class="nav-link" href="/#/nav/about">About</a></li>
          </ul>

          <form class="form-inline my-2 my-lg-0">
            <div class="dropdown">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Search"
                       on-blur="_onBlur" value="{{query::input}}">
                <span class="input-group-addon fa fa-fw fa-search"></span>
              </div>
              <fabric-algolia application-id="BH4D9OD16A"
                              api-key="e3f0d4e7cfac4e1065a92f60b3ec28d1"
                              index="warp10"
                              query="[[query]]"
                              response="{{response}}"></fabric-algolia>
              <div class="dropdown-menu" id="dropdown-menu"></div>
            </div>
          </form>
        </div>
      </div>
    </nav>
    <div class="navbar-separator"></div>
  </template>
  <script>
    class Warp10Nav extends Polymer.Element {
      static get is() {
        return 'warp10-nav'
      }

      static get properties() {
        return {
          show: {
            type: Boolean,
            value: true,
            observer: '_topChanged',
          },
          hasTansparency: {
            type: Boolean,
            value: true,
          },
          _onTop: {
            type: Boolean,
            value: true,
            observer: '_topChanged'
          },
          scrollPosY: {
            type: Number,
            value: 0,
          },
          scrollOffsetY: {
            type: Number,
            value: 1,
          },
          path: {
            type: String,
            observer: '_pathChanged',
          },
          response: {
            type: Object,
            value: function () {
              return {};
            },
            observer: '_onResponse'
          }
        };
      }

      ready() {
        super.ready();
        this.init();
        this.menuopen = false;
      }

      init() {
        this.element = this.root.querySelector('#sps');
      }

      _onBlur() {
        Polymer.Base.async(function(){this.root.querySelector('#dropdown-menu').classList.remove("showMe");}.bind(this), 500);
      }

      _toggleMenu() {
        if (this.menuopen) {
          this.root.querySelector('#navbarCollapse1').classList.add('collapse');
          if (this._onTop && this.hasTansparency) {
            this.aboveScrollPos();
          }
        } else {
          this.root.querySelector('#navbarCollapse1').classList.remove('collapse');
          this.belowScrollPos();
        }
        this.menuopen = !this.menuopen;
      }

      equals(a, b) {
        console.log('[warp10-nav] equals', 'a : ', a, 'b : ', b);
        return (a === b);
      }

      _formatCatPath(h) {
        let res = [];
        Object.keys(h).filter(function (k) {
          return !!this[k];
        }, h).sort().forEach(function (k) {
          res.push(this[k].value);
        }, h);

        return res.join(' &gt; ');
      }

      _pathChanged(path) {
        this._topChanged(this.show);
        //    console.log('[warp10-nav] - _pathChanged', path);
        this.$.menu.childNodes.forEach(function (n) {
          if ('LI' === n.nodeName) {
            if (n.firstChild.href.slice(n.firstChild.href.indexOf('#') + 1) === path) {
              n.classList.add('active');
            } else {
              n.classList.remove('active');
            }
          }
        });
      }

      _onResponse(resp) {
        console.log('[warp10-nav] _onResponse', this.response, resp);
        if (this.response && this.response.hits) {
          this.root.querySelector('#dropdown-menu').classList.add("showMe");
          let html = '';
          this.response.hits.forEach(function (i) {
            html += `<a class="dropdown-item" href="${this._formatURI(i.url)}">${this._formatCatPath(i._highlightResult.hierarchy)}</a>`;
          }, this);
          this.root.querySelector('#dropdown-menu').innerHTML = html;
        }
      }

      _formatURI(url) {
        url = url.replace('http://www.warp10.io/', '');
        return '#/doc/' + url.slice(0, url.indexOf('#') - 1);
      }

      _topChanged(ontop) {
        console.log('[warp10-nav] - _topChanged', ontop,this.hasTansparency === true);
        if (this.element !== undefined) {
          if (ontop && this.hasTansparency) {
            window.requestAnimationFrame(function () {
              this.aboveScrollPos();
            }.bind(this));
          } else {
            window.requestAnimationFrame(function () {
              this.belowScrollPos();
            }.bind(this));
          }
        }
      }

      aboveScrollPos() {
        this.element.classList.add("sps--abv");
        this.element.classList.remove("sps--blw");
      }

      belowScrollPos() {
        this.element.classList.add("sps--blw");
        this.element.classList.remove("sps--abv");
      }
    }

    customElements.define(Warp10Nav.is, Warp10Nav);
  </script>
</dom-module>