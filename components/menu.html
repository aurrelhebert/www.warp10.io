<link rel="import" href="./styles.html">
<link rel="import" href="iron-ajax/iron-ajax.html">
<link rel="import" href="polymer/polymer.html">
<link rel="import" href="iron-collapse/iron-collapse.html">

<dom-module id="warp10-menu">

  <template>
    <style include="style-module">

    </style>
    <iron-ajax
      auto
      url="/raw/menu.json"
      handle-as="json"
      on-response="_handleResponse"
      last-response="{{ajaxResponse}}"
      debounce-duration="300"></iron-ajax>

    <div id="content"></div>

  </template>
  <script>
    class Warp10Menu extends Polymer.Element {
      static get is() {
        return 'warp10-menu'
      }

      static get properties() {
        return {
          menu: {
            type: Object,
            value: function () {
              return {};
            },
          },
        }
      }
      _toggle(evt) {
        this.shadowRoot.querySelector(evt.path[0].attributes['data-target'].value).toggle();
        if(evt.path[0].attributes['data-target'].value === '!#') {
          evt.preventDefault();
          return false;
        }
      }
      _buildMenu(menu) {
        let htmlMenu = '';
        Object.keys(menu).forEach(function (m) {
          htmlMenu += `<li>`;
          if(menu[m].hasOwnProperty('children') &&  Object.keys(menu[m].children).length > 0) {
            htmlMenu += `<a data-target="#${m}" href="!#" >${this._capitalizeFirstLetter(menu[m].title)}</a><iron-collapse id="${m}"><ul>${this._buildMenu(menu[m].children)}`;
          } else {
            htmlMenu += `<a data-target="#${m}" href="#/doc/${m}/">${this._capitalizeFirstLetter(menu[m].title)}</a><iron-collapse id="${m}"><ul>`;
          }

          if(menu[m].hasOwnProperty('links')) {
            menu[m]['links'].forEach(function(link){
              htmlMenu += `<li><a href="#/doc/${link.path}">${this._capitalizeFirstLetter(link.title)}</a></li>`;
            }, this);
          }
          htmlMenu += '</iron-collapse></li></ul>';
        }, this);
        return htmlMenu;
      }
      _capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      _handleResponse(event, ironRequest) {
        event.stopPropagation();
        console.log(ironRequest.response);
        this.menu = {};
        Object.keys(ironRequest.response).forEach(function (item) {
          console.log(item);
          let arr = item.split('/');
          console.log(arr);
          if (!this.menu.hasOwnProperty(arr[0])) {
            this.menu[arr[0]] = {title: arr[0], children: {}, links: []}
          }
          this.menu[arr[0]].links = this.menu[arr[0]].links.concat(ironRequest.response[item]);
          let tmpArr = this.menu[arr[0]].children;
          for (let i = 1; i < arr.length; i++) {
            if (!tmpArr.hasOwnProperty(arr[i])) {
              tmpArr[arr[i]] = {title: arr[i], children: {}, links: []}
            }
            if (i === arr.length - 1) {
              tmpArr[arr[i]].links = tmpArr[arr[i]].links.concat(ironRequest.response[item]);
            }
            tmpArr = tmpArr[arr[i]];
          }
        }, this);
        console.log(this.menu);

        this.root.querySelector('#content').innerHTML = `<ul>${this._buildMenu(this.menu)}</ul>`;
        this.root.querySelector('#content').querySelectorAll('a').forEach(function (element) {
          if(!!element.getAttribute('data-target')) {
            element.addEventListener('click', this._toggle.bind(this));
          }
        }, this);
      }
    }

    customElements.define(Warp10Menu.is, Warp10Menu);
  </script>
</dom-module>